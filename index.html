<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen p-5 text-gray-800">
  <div class="container max-w-2xl mx-auto">
    <div class="bg-white rounded-2xl p-8 shadow-2xl mb-5">
      <h1 class="text-3xl font-bold text-indigo-500 mb-2">üéØ Pre-Trade Checklist</h1>
      <div id="timeStatus" class="text-sm px-3 py-2 rounded-lg font-semibold mb-5"></div>
      
      <div id="successMessage" class="hidden bg-green-100 text-green-800 p-5 rounded-lg text-center font-semibold mb-5">
        ‚úÖ Trade Approved & Logged!
      </div>
      
      <div id="errorBox" class="hidden bg-red-100 text-red-800 p-4 rounded-lg mb-5 border-l-4 border-red-500">
        <strong>‚ùå Cannot Execute Trade:</strong>
        <ul id="errorList" class="ml-5 mt-2 list-disc"></ul>
      </div>
      
      <form id="tradeForm">
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Prop Firm</label>
          <select id="firm" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
            <option value="">Select Firm...</option>
            <option value="Personal">Personal</option>
            <option value="Bulenox">Bulenox</option>
            <option value="Lucid">Lucid Trading</option>
            <option value="MyFundedFutures">My Funded Futures</option>
            <option value="Phidias">Phidias</option>
            <option value="TakeProfitTrader">TakeProfitTrader</option>
            <option value="TopStep">TopStep</option>
            <option value="TradeDay">TradeDay</option>
            <option value="Tradeify">Tradeify</option>
          </select>
        </div>
        
        <div class="mb-5" id="accountTypeWrapper" style="display: none;">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Account Type</label>
          <select id="accountType" class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
            <option value="">Select Account Type...</option>
          </select>
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Account ID (Optional)</label>
          <input type="text" id="accountId" placeholder="LFE0505707701015" class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Symbol (Futures Asset)</label>
          <select id="symbol" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
            <option value="">Select...</option>
            <option value="Gold">Gold (GC)</option>
            <option value="Silver">Silver (SI)</option>
            <option value="Crude Oil">Crude Oil (CL)</option>
            <option value="Natural Gas">Natural Gas (NG)</option>
            <option value="Nasdaq">Nasdaq 100 (NQ)</option>
            <option value="S&P 500">S&P 500 (ES)</option>
            <option value="Dow Jones">Dow Jones (YM)</option>
            <option value="Russell 2000">Russell 2000 (RTY)</option>
            <option value="Bitcoin">Bitcoin (BTC)</option>
            <option value="Ethereum">Ethereum (ETH)</option>
            <option value="Euro">Euro (6E)</option>
            <option value="10-Year Treasury">10-Year Treasury (ZN)</option>
          </select>
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Contract (Optional)</label>
          <input type="text" id="contract" placeholder="e.g., GCG6, NQH6" class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Direction</label>
          <select id="direction" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
            <option value="">Select...</option>
            <option value="buy">BUY (at low)</option>
            <option value="sell">SELL (at high)</option>
          </select>
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Entry Price ($)</label>
          <input type="number" id="entry" step="0.01" placeholder="45.23" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Stop Loss ($)</label>
          <input type="number" id="stop" step="0.01" placeholder="44.80" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Target Price ($)</label>
          <input type="number" id="target" step="0.01" placeholder="46.10" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
        </div>
        
        <div class="mb-5">
          <label class="block font-semibold mb-2 text-sm text-gray-600">Position Size (shares/contracts)</label>
          <input type="number" id="positionSize" step="1" placeholder="100" required class="w-full p-3 border-2 border-gray-200 rounded-lg text-base transition-colors focus:outline-none focus:border-indigo-500">
        </div>
        
        <div id="rrDisplay" class="hidden bg-gray-50 p-5 rounded-xl my-5 border-l-4 border-indigo-500">
          <h3 class="text-base font-semibold mb-3 text-indigo-500">üìä Risk/Reward Analysis</h3>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-500">Risk:</span>
              <span class="font-semibold text-gray-800" id="riskValue">$0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Reward:</span>
              <span class="font-semibold text-gray-800" id="rewardValue">$0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Max Risk:</span>
              <span class="font-semibold text-gray-800" id="maxRiskValue">$0.00</span>
            </div>
            <div class="col-span-2 text-lg font-bold pt-3 mt-3 border-t-2 border-gray-200 flex justify-between items-center" id="rrRatio">
              <span>R:R Ratio:</span>
              <span id="rrValue">1:0.00</span>
            </div>
          </div>
        </div>
        
        <div class="mb-5">
          <div class="flex items-center gap-3">
            <input type="checkbox" id="stopOnPrevious" required class="w-5 h-5 cursor-pointer">
            <label for="stopOnPrevious" class="font-semibold text-sm text-gray-600 mb-0">Stop loss on previous low/high</label>
          </div>
        </div>
        
        <div class="mb-5">
          <div class="flex items-center gap-3">
            <input type="checkbox" id="fibTarget" required class="w-5 h-5 cursor-pointer">
            <label for="fibTarget" class="font-semibold text-sm text-gray-600 mb-0">Target based on Fibonacci levels</label>
          </div>
        </div>
        
        <div class="mb-5">
          <div class="flex items-center gap-3">
            <input type="checkbox" id="conviction" class="w-5 h-5 cursor-pointer">
            <label for="conviction" class="font-semibold text-sm text-gray-600 mb-0">Price bounced with CONVICTION</label>
          </div>
        </div>
        
        <div class="flex gap-3">
          <button type="button" class="flex-1 p-4 border-none rounded-lg text-base font-semibold cursor-pointer transition-all bg-gray-500 text-white hover:bg-gray-600" onclick="resetForm()">Cancel</button>
          <button type="submit" class="flex-1 p-4 border-none rounded-lg text-base font-semibold cursor-pointer transition-all bg-green-500 text-white hover:bg-green-600 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" id="approveBtn">Approve Trade</button>
        </div>
      </form>
    </div>
    
    <div class="bg-white rounded-2xl p-8 shadow-2xl">
      <h2 class="text-2xl font-bold mb-4">üìù Recent Trades</h2>
      <div id="tradeHistory">Loading...</div>
    </div>
  </div>
  
  <script>
    let currentTimeStatus = false;
    
    // Account types by firm (based on actual 2026 offerings)
    const firmAccounts = {
      'Personal': ['Personal Account'],
      'Bulenox': ['10K', '25K', '50K', '100K', '150K', '250K'],
      'Lucid': [
        'LucidFlex 25K', 'LucidFlex 50K', 'LucidFlex 100K', 'LucidFlex 150K',
        'LucidBlack 25K', 'LucidBlack 50K', 'LucidBlack 100K', 'LucidBlack 150K',
        'LucidDirect 25K', 'LucidDirect 50K', 'LucidDirect 100K', 'LucidDirect 150K',
        'Lucid Test 25K', 'Lucid Test 50K', 'Lucid Test 100K', 'Lucid Test 150K'
      ],
      'MyFundedFutures': [
        'Rapid 50K', 'Rapid 100K', 'Rapid 150K',
        'Pro 50K', 'Pro 100K', 'Pro 150K',
        'Flex 50K'
      ],
      'Phidias': [
        'Fundamental 50K', 'Fundamental 100K',
        'Swing 50K', 'Swing 100K',
        'Static 25K',
        '10K Drawdown',
        'Master 1M'
      ],
      'TakeProfitTrader': ['25K', '50K', '75K', '100K', '150K'],
      'TopStep': ['50K', '100K', '150K'],
      'TradeDay': ['50K', '100K', '150K'],
      'Tradeify': [
        'Lightning 25K', 'Lightning 50K', 'Lightning 100K', 'Lightning 150K',
        'Growth 25K', 'Growth 50K', 'Growth 100K', 'Growth 150K',
        'Select 25K', 'Select 50K', 'Select 100K', 'Select 150K'
      ]
    };
    
    // Update account dropdown when firm changes
    document.getElementById('firm').addEventListener('change', function() {
      const firm = this.value;
      const accountTypeWrapper = document.getElementById('accountTypeWrapper');
      const accountTypeSelect = document.getElementById('accountType');
      
      if (!firm) {
        accountTypeWrapper.style.display = 'none';
        accountTypeSelect.innerHTML = '<option value="">Select Account Type...</option>';
        return;
      }
      
      const accounts = firmAccounts[firm] || [];
      accountTypeSelect.innerHTML = '<option value="">Select Account Type...</option>' + 
        accounts.map(acc => `<option value="${acc}">${acc}</option>`).join('');
      
      accountTypeWrapper.style.display = 'block';
    });
    
    // Check time on load
    async function checkTime() {
      const res = await fetch('http://104.236.41.155:8080/api/time');
      const data = await res.json();
      
      const statusEl = document.getElementById('timeStatus');
      currentTimeStatus = data.allowed;
      
      if (data.allowed) {
        statusEl.className = 'text-sm px-3 py-2 rounded-lg font-semibold mb-5 bg-green-100 text-green-800';
        statusEl.textContent = `‚úÖ Market Open - ${data.currentTime} EST`;
      } else {
        statusEl.className = 'text-sm px-3 py-2 rounded-lg font-semibold mb-5 bg-red-100 text-red-800';
        statusEl.textContent = `üîí Outside Trading Hours - ${data.currentTime} EST (${data.tradingHours})`;
      }
      
      document.getElementById('approveBtn').disabled = !data.allowed;
    }
    
    // Calculate R:R as user types
    function calculateRR() {
      const entry = parseFloat(document.getElementById('entry').value);
      const stop = parseFloat(document.getElementById('stop').value);
      const target = parseFloat(document.getElementById('target').value);
      const positionSize = parseFloat(document.getElementById('positionSize').value) || 0;
      
      if (!entry || !stop || !target) {
        document.getElementById('rrDisplay').classList.add('hidden');
        return;
      }
      
      const risk = Math.abs(entry - stop);
      const reward = Math.abs(target - entry);
      const rr = reward / risk;
      const maxRisk = risk * positionSize;
      
      document.getElementById('rrDisplay').classList.remove('hidden');
      document.getElementById('riskValue').textContent = `$${risk.toFixed(2)}`;
      document.getElementById('rewardValue').textContent = `$${reward.toFixed(2)}`;
      document.getElementById('maxRiskValue').textContent = `$${maxRisk.toFixed(2)}`;
      document.getElementById('rrValue').textContent = `1:${rr.toFixed(2)}`;
      
      const rrRatio = document.getElementById('rrRatio');
      if (rr >= 2) {
        rrRatio.className = 'col-span-2 text-lg font-bold pt-3 mt-3 border-t-2 border-gray-200 flex justify-between items-center text-green-600';
      } else {
        rrRatio.className = 'col-span-2 text-lg font-bold pt-3 mt-3 border-t-2 border-gray-200 flex justify-between items-center text-red-600';
      }
    }
    
    // Form submission
    document.getElementById('tradeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        account: document.getElementById('firm').value,
        accountId: document.getElementById('accountId').value,
        accountType: document.getElementById('accountType').value,
        symbol: document.getElementById('symbol').value,
        direction: document.getElementById('direction').value,
        entry: parseFloat(document.getElementById('entry').value),
        stop: parseFloat(document.getElementById('stop').value),
        target: parseFloat(document.getElementById('target').value),
        positionSize: parseFloat(document.getElementById('positionSize').value),
        stopOnPrevious: document.getElementById('stopOnPrevious').checked,
        fibTarget: document.getElementById('fibTarget').checked,
        conviction: document.getElementById('conviction').checked,
      };
      
      // Validate
      const res = await fetch('http://104.236.41.155:8080/api/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      
      const result = await res.json();
      
      if (!result.valid) {
        const errorBox = document.getElementById('errorBox');
        const errorList = document.getElementById('errorList');
        
        errorBox.classList.remove('hidden');
        
        if (result.error) {
          errorList.innerHTML = `<li>${result.message}</li>`;
        } else {
          errorList.innerHTML = result.errors.map(err => `<li>${err}</li>`).join('');
        }
        
        document.getElementById('successMessage').classList.add('hidden');
        return;
      }
      
      // Log trade
      const logRes = await fetch('http://104.236.41.155:8080/api/log-trade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...data,
          risk: result.risk,
          reward: result.reward,
          rr: result.rr,
          maxRisk: result.maxRisk,
        }),
      });
      
      await logRes.json();
      
      // Show success
      document.getElementById('errorBox').classList.add('hidden');
      document.getElementById('successMessage').classList.remove('hidden');
      
      // Reload history
      loadHistory();
      
      // Reset form after 2 seconds
      setTimeout(() => {
        resetForm();
        document.getElementById('successMessage').classList.add('hidden');
      }, 2000);
    });
    
    function resetForm() {
      document.getElementById('tradeForm').reset();
      document.getElementById('rrDisplay').classList.add('hidden');
      document.getElementById('errorBox').classList.add('hidden');
      document.getElementById('accountTypeWrapper').style.display = 'none';
    }
    
    async function journalTradeFromHistory(trade) {
      const buttons = document.querySelectorAll('[id^="journal-btn-"]');
      let btn = null;
      
      for (const b of buttons) {
        if (b.textContent.includes('Journal')) {
          const row = b.closest('tr');
          const timeCell = row.querySelector('td:first-child');
          const tradeTime = new Date(trade.timestamp).toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          });
          
          if (timeCell.textContent === tradeTime) {
            btn = b;
            break;
          }
        }
      }
      
      if (!btn) return;
      
      btn.textContent = 'Journaling...';
      btn.disabled = true;
      
      try {
        const res = await fetch('http://104.236.41.155:8080/api/journal-to-notion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(trade),
        });
        
        const result = await res.json();
        
        if (result.success) {
          btn.textContent = '‚úÖ Journaled!';
          btn.className = 'px-3 py-1 bg-green-500 text-white border-none rounded cursor-pointer text-xs font-semibold';
        } else {
          btn.textContent = '‚ùå Failed';
          btn.className = 'px-3 py-1 bg-red-500 text-white border-none rounded cursor-pointer text-xs font-semibold';
          btn.disabled = false;
          alert('Failed to journal: ' + result.error);
        }
      } catch (error) {
        btn.textContent = '‚ùå Error';
        btn.className = 'px-3 py-1 bg-red-500 text-white border-none rounded cursor-pointer text-xs font-semibold';
        btn.disabled = false;
        alert('Error: ' + error.message);
      }
    }
    
    async function loadHistory() {
      const res = await fetch('http://104.236.41.155:8080/api/trades');
      const data = await res.json();
      
      const historyEl = document.getElementById('tradeHistory');
      
      if (data.trades.length === 0) {
        historyEl.innerHTML = '<p class="text-gray-400">No trades yet</p>';
        return;
      }
      
      const table = `
        <table class="w-full border-collapse mt-4 text-xs">
          <thead>
            <tr class="bg-gray-50">
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">Time</th>
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">Symbol</th>
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">Account</th>
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">Dir</th>
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">Entry</th>
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">R:R</th>
              <th class="p-2 text-left font-semibold border-b-2 border-gray-300">Action</th>
            </tr>
          </thead>
          <tbody>
            ${data.trades.slice(0, 10).map((t, idx) => {
              const badgeClass = t.direction === 'buy' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
              return `
              <tr class="border-b border-gray-200">
                <td class="p-2">${new Date(t.timestamp).toLocaleString('en-US', { 
                  month: 'short', 
                  day: 'numeric', 
                  hour: 'numeric', 
                  minute: '2-digit' 
                })}</td>
                <td class="p-2"><strong>${t.symbol || 'N/A'}</strong></td>
                <td class="p-2">${t.accountType || t.account || 'N/A'}</td>
                <td class="p-2"><span class="inline-block px-2 py-1 rounded text-xs font-semibold ${badgeClass}">${t.direction.toUpperCase()}</span></td>
                <td class="p-2">$${t.entry}</td>
                <td class="p-2">1:${t.rr}</td>
                <td class="p-2">
                  <button onclick='journalTradeFromHistory(${JSON.stringify(t).replace(/'/g, "\\'")})'
                    class="px-3 py-1 bg-indigo-500 text-white border-none rounded cursor-pointer text-xs font-semibold hover:bg-indigo-600"
                    id="journal-btn-${idx}">
                    üìù Journal
                  </button>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
      
      historyEl.innerHTML = table;
    }
    
    // Event listeners
    ['entry', 'stop', 'target', 'positionSize'].forEach(id => {
      document.getElementById(id).addEventListener('input', calculateRR);
    });
    
    // Initialize
    checkTime();
    loadHistory();
    setInterval(checkTime, 60000); // Update time every minute
  </script>
</body>
</html>
